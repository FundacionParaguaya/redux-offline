"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[515],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return d}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},f=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),f=l(n),d=o,m=f["".concat(c,".").concat(d)]||f[d]||p[d]||a;return n?r.createElement(m,s(s({ref:t},u),{},{components:n})):r.createElement(m,s({ref:t},u))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=f;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var l=2;l<a;l++)s[l]=n[l];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}f.displayName="MDXCreateElement"},1772:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return c},metadata:function(){return l},toc:function(){return u},default:function(){return f}});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),s=["components"],i={sidebar_position:1,title:"Customize Requests"},c=void 0,l={unversionedId:"recepies/customize-requests",id:"recepies/customize-requests",isDocsHomePage:!1,title:"Customize Requests",description:"Configure how requests are made",source:"@site/docs/recepies/customize-requests.md",sourceDirName:"recepies",slug:"/recepies/customize-requests",permalink:"/redux-offline/docs/recepies/customize-requests",editUrl:"https://github.com/redux-offline/redux-offline/blob/develop/docs/recepies/customize-requests.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Customize Requests"},sidebar:"tutorialSidebar",previous:{title:"Commit",permalink:"/redux-offline/docs/basics/commit"},next:{title:"Immutable",permalink:"/redux-offline/docs/recepies/immutable"}},u=[{value:"Configure how requests are made",id:"configure-how-requests-are-made",children:[{value:"The effect reconciler",id:"the-effect-reconciler",children:[],level:3}],level:2},{value:"Example: Using axios",id:"example-using-axios",children:[],level:2},{value:"Example: <code>async</code> discard",id:"example-async-discard",children:[],level:2}],p={toc:u};function f(e){var t=e.components,n=(0,o.Z)(e,s);return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"configure-how-requests-are-made"},"Configure how requests are made"),(0,a.kt)("h3",{id:"the-effect-reconciler"},"The effect reconciler"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"config.effect")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"config.discard")," together are responsible for executing a serialized request and resolving it to one of three outcomes. These outcomes and their resulting actions are success and commit, temporary failure and retry, and permanent failure and rollback."),(0,a.kt)("p",null,"The following code demonstrates roughly how these functions are used in the codebase."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const offlineData = offlineAction.meta.offline;\n\nconfig.effect(offlineData.effect)\n  .then(response => {\n    // dispatch offlineData.commit action\n  })\n  .catch(error => {\n    if (config.discard(error)) {\n      // dispatch offlineData.rollback action\n    } else {\n      // retry request after some delay\n    }\n  });\n")),(0,a.kt)("p",null,"If you would like to change how Redux Offline processes requests, you should provide your own implementation for both ",(0,a.kt)("inlineCode",{parentName:"p"},"effect")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"discard"),"."),(0,a.kt)("h2",{id:"example-using-axios"},"Example: Using axios"),(0,a.kt)("p",null,"Let's write ",(0,a.kt)("inlineCode",{parentName:"p"},"effect")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"discard")," functions using the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/axios/axios"},"axios")," library."),(0,a.kt)("p",null,"The effect reconciler accepts an effect object describing the request, and the offline action associated with that request. Assuming the effect object is a valid axios config object, the implementation could be as simple as:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const effect = (effect, _action) => axios(effect);\n")),(0,a.kt)("p",null,"For the discard function, to duplicate the behavior of the default implementation, we will return true if the provided error represents a client error. So a status code of ",(0,a.kt)("inlineCode",{parentName:"p"},"4xx"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const discard = (error, _action, _retries) => {\n  const { response } = error;\n  return response && 400 <= response.status && response.status < 500;\n}\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"A production ready implementation would also consider errors triggered during creating the request. These are currently grouped with network and server errors which is incorrect. You should instead rethrow so as to not obscure the underlying error, which almost certainly represents a bug.")),(0,a.kt)("p",null,"The following is a full example using axios to resolve requests."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const effect = (effect, _action) => axios(effect);\nconst discard = (error, _action, _retries) => {\n  const { request, response } = error;\n  if (!request) throw error; // There was an error creating the request\n  if (!response) return false; // There was no response\n  return 400 <= response.status && response.status < 500;\n};\n\nconst store = createStore(myReducer, offline({\n  ...config,\n  effect,\n  discard\n}));\n\nstore.dispatch({\n  type: 'SOME_OFFLINE_ACTION',\n  meta: {\n    offline: {\n      effect: { url: 'example.com' }\n    }\n  }\n});\n")),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://codesandbox.io/s/jp6zrj3pj5"},"Try it on CodeSandbox.")),(0,a.kt)("h2",{id:"example-async-discard"},"Example: ",(0,a.kt)("inlineCode",{parentName:"h2"},"async")," discard"),(0,a.kt)("p",null,"The discard function can return a promise. This can be useful if you need to make network requests in response to some failed request, such as refreshing access tokens on ",(0,a.kt)("inlineCode",{parentName:"p"},"401 Unauthorized"),"."),(0,a.kt)("p",null,"In the following example, when we receive a ",(0,a.kt)("inlineCode",{parentName:"p"},"401 Unauthorized")," response, we call ",(0,a.kt)("inlineCode",{parentName:"p"},"refreshAccessToken()"),", update ",(0,a.kt)("em",{parentName:"p"},"localStorage"),", and then return ",(0,a.kt)("inlineCode",{parentName:"p"},"false")," if we received a new access token."),(0,a.kt)("p",null,"Both the code checking for ",(0,a.kt)("inlineCode",{parentName:"p"},"status")," on error and the code checking that ",(0,a.kt)("inlineCode",{parentName:"p"},"status")," represents a client error is taken from the default implementation."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const discard = async (error, _action, _retries) => {\n  if (!status in error) return false;\n\n  if (error.status === 401) {\n    const newAccessToken = await refreshAccessToken();\n    localStorage.set('accessToken', newAccessToken);\n    return newAccessToken == null;\n  }\n\n  return 400 <= error.status && error.status < 500;\n}\n")))}f.isMDXComponent=!0}}]);